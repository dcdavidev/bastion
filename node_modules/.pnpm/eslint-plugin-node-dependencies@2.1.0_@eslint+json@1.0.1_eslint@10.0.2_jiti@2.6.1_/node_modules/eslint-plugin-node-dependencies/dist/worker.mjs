import { runAsWorker } from "synckit";
import packageJson from "package-json";
import { ProxyAgent, setGlobalDispatcher } from "undici";

//#region lib/utils/package-json/worker.ts
let proxySet = false;
const PROXY_ENV = [
	"https_proxy",
	"HTTPS_PROXY",
	"http_proxy",
	"HTTP_PROXY",
	"npm_config_https_proxy",
	"npm_config_http_proxy"
];
/**
* If users are using a proxy for their npm preferences, set the option to use that proxy.
*/
function setupProxy() {
	if (proxySet) return;
	proxySet = true;
	const proxy = PROXY_ENV.map((k) => process.env[k]).find((v) => v);
	if (proxy) setGlobalDispatcher(new ProxyAgent(proxy));
}
runAsWorker((packageName) => {
	setupProxy();
	return packageJson(packageName, { allVersions: true });
});

//#endregion
export { setupProxy };