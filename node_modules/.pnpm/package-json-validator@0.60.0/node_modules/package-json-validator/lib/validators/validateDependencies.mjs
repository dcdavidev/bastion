import { ChildResult, Result } from "../Result.mjs";
import { packageFormat, urlFormat } from "../formats.mjs";
import { validRange } from "semver";

//#region src/validators/validateDependencies.ts
const isUnpublishedVersion = (version) => {
	return urlFormat.test(version) || /^git(?:\+(?:ssh|http|https|file|rsync|ftp))?:/.test(version) || /^(?:github:)?[a-zA-Z0-9]+(?:-[a-zA-Z0-9]+)*\/[\w.-]+(?:#|$)/.test(version) || version.startsWith("workspace:") || version.startsWith("patch:") || version.startsWith("npm:") || version.startsWith("file:") || version.startsWith("../") || version.startsWith("~/") || version.startsWith("./") || version.startsWith("/") || false;
};
const isValidVersionRange = (version) => {
	return !!validRange(version) || version === "*" || version === "" || version === "latest" || version.startsWith("jsr:") || version.startsWith("catalog:") || isUnpublishedVersion(version);
};
/**
* Validates dependencies, making sure the object is a set of key value pairs
* with package names and versions
* @returns An array with validation errors (if any violations are found)
*/
const validateDependencies = (value) => {
	const result = new Result();
	if (value == null) result.addIssue("the value is `null`, but should be a record of dependencies");
	else if (typeof value === "object" && !Array.isArray(value)) {
		const entries = Object.entries(value);
		for (let i = 0; i < entries.length; ++i) {
			const childResult = new ChildResult(i);
			const [pkg, version] = entries[i];
			if (!packageFormat.test(pkg) && !(typeof version === "string" && isUnpublishedVersion(version))) childResult.addIssue(`invalid dependency package name: ${pkg}`);
			if (typeof version !== "string") childResult.addIssue(`dependency version for ${pkg} should be a string: ${version}`);
			else if (!isValidVersionRange(version)) childResult.addIssue(`invalid version range for dependency ${pkg}: ${version}`);
			result.addChildResult(childResult);
		}
	} else {
		const valueType = Array.isArray(value) ? "array" : typeof value;
		result.addIssue(`the type should be \`object\`, not \`${valueType}\``);
	}
	return result;
};

//#endregion
export { validateDependencies };