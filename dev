#!/bin/bash

# Function to clean up background processes on exit
cleanup() {
    echo ""
    echo "Stopping development services..."
    # Kill all child processes of this script
    pkill -P $$ 2>/dev/null
    docker compose stop db
    exit
}

# Trap SIGINT (Ctrl+C) and SIGTERM
trap cleanup SIGINT SIGTERM

# Check dependencies
if ! command -v docker &> /dev/null; then
    echo "Error: docker is not installed."
    exit 1
fi

if ! command -v go &> /dev/null; then
    echo "Error: go is not installed or not in PATH."
    exit 1
fi

if ! command -v pnpm &> /dev/null; then
    echo "Error: pnpm is not installed."
    exit 1
fi

echo "Starting Bastion development environment..."

# 1. Start Database
echo "Starting PostgreSQL..."
docker compose up -d db

# 2. Run Backend
echo "Starting Backend..."
go run cmd/server/main.go &

# 3. Run Frontend
echo "Starting Frontend..."
cd frontend && pnpm dev &

# Wait for all background processes
wait
